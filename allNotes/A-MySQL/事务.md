# äº‹åŠ¡





## éšæœºIOå’Œé¡ºåºIOçš„åŒºåˆ«

éšæœºIO éœ€è¦æ‰¾åˆ°ä½ç½® ç„¶åŽæ·»åŠ æ•°æ®

é¡ºåºIOï¼Œç›´æŽ¥ç›´åˆ°ä½ç½®ï¼Œç›´æŽ¥æ·»åŠ æ•°æ®å°±å¯ä»¥äº†ï¼›

é¡ºåºIOå¾ˆå¿«çš„ï¼›å¯ä»¥å’Œå†…å­˜éšæœºå†™å…¥å·®ä¸å¤šçš„é€Ÿåº¦ï¼›

---



## ACID

A atomicity  åŽŸå­æ€§  ä¸€ç³»åˆ—æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ï¼›  



| äº‹åŠ¡ç‰¹æ€§ï¼š          | ç®€è¿°                                   | åŽŸç†                                      |
| ------------------- | -------------------------------------- | ----------------------------------------- |
| A atomicity åŽŸå­æ€§  | ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ï¼›         | undo log å›žæ»šæ—¥å¿—ï¼›                       |
| c consistent ä¸€è‡´æ€§ | æ•°æ®çš„ä¸€è‡´æ€§ï¼›                         | å…±åŒæ¥ä¿è¯ï¼›                              |
| i isolation  éš”ç¦»æ€§ | å¹¶å‘æ‰§è¡Œäº‹åŠ¡ï¼›å¹¶å‘æ‰§è¡Œäº‹åŠ¡ï¼›           | mvcc  å’Œ  é”ï¼›                            |
| d durability æŒä¹…æ€§ | ä¸€æ—¦äº‹åŠ¡æäº¤å¯¹æ•°æ®åº“çš„æ›´æ–°å°±æ˜¯æŒä¹…çš„ï¼› | redo log WALé¢„å†™æ—¥å¿— cash-safe å´©æºƒå®‰å…¨ï¼› |



**å¦‚æžœ æ²¡æœ‰redolog  å†…å­˜é‡Œé¢çš„æ•°æ®å°±æ²¡æ³• æ¢å¤ï¼›å°±ä¼šå¯¼è‡´ä¸€ä¸ªæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼›æ•°æ®ä¼šä¸¢å¤±ï¼›**



**å†™æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå…ˆåŽ»ä¿®æ”¹å†…å­˜çš„æ•°æ®ï¼Œç„¶åŽå…ˆå†™redolog   ç„¶åŽåŽ»è½ç›˜å¤„ç†ï¼›**



`````mysql
mysql> select version();
# äº‹åŠ¡çš„ä¿®æ”¹ 0 1 2 3 åˆ†åˆ«ä»£è¡¨å››ä¸ªéš”ç¦»çº§åˆ«ï¼Œè¿™ä¸ªåªæ˜¯ä¸´æ—¶çš„ä¿®æ”¹ï¼›
mysql> set transaction_isolation=1;  

mysql> set tx_isolation=1;
Query OK, 0 rows affected (0.00 sec)
# è‡ªåŠ¨æäº¤å…³é—­ï¼›

mysql> set autocommit=0;
Query OK, 0 rows affected (0.00 sec)


mysql> show variables like 'tx_isolation';
+---------------+----------------+
| Variable_name | Value          |
+---------------+----------------+
| tx_isolation  | READ-COMMITTED |
+---------------+----------------+
1 row in set (0.00 sec)


#5.7ä¹‹åŽ
mysql> show variables like 'transaction_isolation';
#5.6ä¹‹å‰ç‰ˆæœ¬éƒ½æ˜¯tx_transation é»˜è®¤éƒ½æ˜¯å¯é‡è¯»è¯»ï¼›5.6ç‰ˆæœ¬æœ‰äº†ç´¢å¼•ä¸‹æŽ¨ï¼Œ5.5ç‰ˆæœ¬é»˜è®¤engineå­˜å‚¨å¼•æ“Žæ˜¯innodbï¼›

show variables like 'tx_isolation'

mysql> show variables like "tx_isolation";
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| tx_isolation  | REPEATABLE-READ |
+---------------+-----------------+
1 row in set (0.00 sec)

#è¿™å¥å†™é”™äº†ï¼Œåº”è¯¥æ˜¯tx_isolationã€‚æµ‹è¯•äº†ä¸€ä¸‹ 5.6 æˆ–è€…ä¹‹å‰çš„ç‰ˆæœ¬ï¼›
#ä½œè€…å›žå¤: ä½ æ˜¯ä¸æ˜¯ç”¨çš„5.6æˆ–æ›´æ—©çš„ç‰ˆæœ¬ðŸ˜„

#5.7å¼•å…¥äº†transaction_isolationç”¨æ¥æ›¿æ¢tx_isolationäº†ï¼Œåˆ°8.0.3å°±åŽ»æŽ‰äº†åŽè€…äº†
`````



---



## I  isolation  éš”ç¦»æ€§   å¹¶å‘æ‰§è¡Œäº‹åŠ¡ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œæˆ–è€…è¯´å¯è§æ€§ï¼›

**éš”ç¦»çº§åˆ«**

* è¯»æœªæäº¤  read-uncommit  
  *  è„è¯»  äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œåˆ«çš„äº‹åŠ¡å°±å¯ä»¥è¯»åˆ°ä¿®æ”¹ï¼›
  * å¹»è¯»   æ˜¯å› ä¸ºåŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡æŸ¥è¯¢çš„æ•°æ®æ•°é‡å‘ç”Ÿå˜åŒ–ï¼›
  * ä¸å¯é‡è¯»   åŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡çš„select çš„æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼›

  
  
* è¯»å·²æäº¤ read-committed   ä¸€è‡´æ€§è§†å›¾æ˜¯åœ¨æ¯ä¸€æ¡sqlçš„æ—¶å€™åˆ›å»ºçš„ï¼›

  * ä¸å¯é‡è¯»
  * å¹»è¯»ï¼›

  

* å¯é‡å¤è¯» repeatable-read   ä¸€è‡´æ€§è§†å›¾æ˜¯åœ¨æ‰§è¡Œç¬¬ä¸€æ¡sqlè¯­å¥çš„æ—¶å€™åˆ›å»ºçš„ï¼›

  * å¹»è¯»

  

* serializable  ä¸²è¡ŒåŒ–ï¼›

  

**åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚**

**åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ª SQL è¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚**

**è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æŽ¥è¿”å›žè®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µï¼›**

**è€Œâ€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æŽ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚**

---

## MVCC å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼›æ˜¯ä¹è§‚é”çš„ä¸€ç§å®žçŽ°æ–¹å¼æŠŠ

> å¿«ç…§è¯»ä¸éœ€è¦æž·é”ï¼›



ä¸€è‡´æ€§è§†å›¾ï¼š  ä¸€æ¡è®°å½•æœ‰å¤šä¸ªç‰ˆæœ¬ï¼›ä¸»è¦æ˜¯åˆ†ä¸ºå‡ éƒ¨åˆ†ç»„æˆï¼›





````mysql
select * from for update; # å†™é”ï¼›
select * from lock in share mode; # åŠ å…±äº«é”ï¼›
#å†™é”ï¼›
update   
insert
delete 
#å°±æ˜¯å®ƒè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–çš„è®°å½•è¿›è¡ŒåŠ é”
````



**å¿«ç…§è¯»ï¼šæ™®é€šè¯» æ˜¯è¯»å–çš„ä¸€è‡´æ€§è§†å›¾çš„å†…å®¹ï¼›**

**å½“å‰è¯»ï¼šå½“å‰è¯» æ˜¯å·²ç»æäº¤äº‹åŠ¡çš„æœ€æ–°æ•°æ®ï¼›**



````mysql
#åƒä¸åŠ é”çš„ select æ“ä½œå°±æ˜¯å¿«ç…§è¯»ï¼Œå³ä¸åŠ é”çš„éžé˜»å¡žè¯»ï¼›å¿«ç…§è¯»çš„å‰ææ˜¯éš”ç¦»çº§åˆ«ä¸æ˜¯ä¸²è¡Œçº§åˆ«ï¼Œä¸²è¡Œçº§åˆ«ä¸‹çš„å¿«ç…§è¯»ä¼šé€€åŒ–æˆå½“å‰è¯»ï¼›ä¹‹æ‰€ä»¥å‡ºçŽ°å¿«ç…§è¯»çš„æƒ…å†µï¼Œæ˜¯åŸºäºŽæé«˜å¹¶å‘æ€§èƒ½çš„è€ƒè™‘ï¼Œå¿«ç…§è¯»çš„å®žçŽ°æ˜¯åŸºäºŽå¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼Œå³ MVCC ,å¯ä»¥è®¤ä¸º MVCC æ˜¯è¡Œé”çš„ä¸€ä¸ªå˜ç§ï¼Œä½†å®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œé¿å…äº†åŠ é”æ“ä½œï¼Œé™ä½Žäº†å¼€é”€ï¼›æ—¢ç„¶æ˜¯åŸºäºŽå¤šç‰ˆæœ¬ï¼Œå³å¿«ç…§è¯»å¯èƒ½è¯»åˆ°çš„å¹¶ä¸ä¸€å®šæ˜¯æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œæœ‰å¯èƒ½æ˜¯ä¹‹å‰çš„åŽ†å²ç‰ˆæœ¬
#ä¸éœ€è¦åŠ é”ï¼›

#è¯´ç™½äº† MVCC å°±æ˜¯ä¸ºäº†å®žçŽ°è¯»-å†™å†²çªä¸åŠ é”ï¼Œè€Œè¿™ä¸ªè¯»æŒ‡çš„å°±æ˜¯å¿«ç…§è¯», è€Œéžå½“å‰è¯»ï¼Œå½“å‰è¯»å®žé™…ä¸Šæ˜¯ä¸€ç§åŠ é”çš„æ“ä½œï¼Œæ˜¯æ‚²è§‚é”çš„å®žçŽ°


#æ€»ä¹‹åœ¨**RCéš”ç¦»çº§åˆ«ä¸‹ï¼Œæ˜¯æ¯ä¸ªå¿«ç…§è¯»éƒ½ä¼šç”Ÿæˆå¹¶èŽ·å–æœ€æ–°çš„Read Viewï¼›**

#è€Œåœ¨**RRéš”ç¦»çº§åˆ«ä¸‹**ï¼Œ**ç¬¬ä¸€æ¡sqlè¯­å¥ï¼Œä¼šåˆ›å»ºä¸€ä¸ªreadview**ï¼›åˆ™æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ä¸­çš„**ç¬¬ä¸€ä¸ªå¿«ç…§è¯»æ‰ä¼šåˆ›å»ºRead View**, ä¹‹åŽçš„å¿«ç…§è¯»èŽ·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªRead Viewã€‚æ¯ä¸€ä¸ªå½“å‰è¯»ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„**read view**ï¼›
````





## mvcc è¿›è¡Œå¹¶å‘äº‹åŠ¡çš„æŽ§åˆ¶ï¼›

ä¸€ä¸ªè®°å½•ä¼šæœ‰å¤šä¸ªç‰ˆæœ¬ï¼›

![image-20220726224244074](äº‹åŠ¡.assets/image-20220726224244074.png)

ä»–æ˜¯æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼›



undo logç‰ˆæœ¬é“¾  è¡Œ æœ‰å¾ˆå¤šéšè—å­—æ®µ---   **trx_Id   roll_ptr**  pointer

![image-20220726224414087](äº‹åŠ¡.assets/image-20220726224414087.png)

![image-20220726224623608](äº‹åŠ¡.assets/image-20220726224623608.png)

readview

![image-20220726224647956](äº‹åŠ¡.assets/image-20220726224647956.png)

![image-20220726224719779](äº‹åŠ¡.assets/image-20220726224719779.png)





rc éš”ç¦»çº§åˆ«



![image-20220726224745422](äº‹åŠ¡.assets/image-20220726224745422.png)

![image-20220726224852471](äº‹åŠ¡.assets/image-20220726224852471.png)

m_ids å°±æ˜¯æ²¡æœ‰è¢«æäº¤çš„äº‹åŠ¡idï¼Œæ‰€ä»¥è‚¯å®šä¸èƒ½è¢«è®¿é—®ï¼›

rr å¯é‡å¤è¯» éš”ç¦»çº§åˆ«

ä»…ä»…ä¼šç”Ÿæˆä¸€ä¸ªreadview;	

![image-20220726225356354](äº‹åŠ¡.assets/image-20220726225356354.png)



![image-20220726225448612](äº‹åŠ¡.assets/image-20220726225448612.png)





![image-20220726225502392](äº‹åŠ¡.assets/image-20220726225502392.png)



**mvccè¿™ä¸ªå¾ˆé‡è¦å¹¶æ²¡æœ‰å®Œå…¨è§£å†³ å¹»ç…§è¯»çš„é—®é¢˜ï¼›** 

 **ä»…ä»…è§£å†³äº†å¤šæ¬¡å¿«ç…§è¯»çš„å¹»è¯»é—®é¢˜ï¼›**



![image-20220726225521499](äº‹åŠ¡.assets/image-20220726225521499.png)

![image-20220726225607711](äº‹åŠ¡.assets/image-20220726225607711.png)



```mysql
# client1
mysql> begin;
Query OK, 0 rows affected (0.00 sec)
#  
mysql> select * from student;
+-------+--------+-------+
| name  | course | score |
+-------+--------+-------+
| name1 | amth   |    81 |
| name2 | amth   |    81 |
| name3 | amth   |    80 |
| name4 | yuwen  |    76 |
| name4 | yuwen  |    72 |
| name4 | yuwen  |    76 |
+-------+--------+-------+
6 rows in set (0.00 sec)
#æ·»åŠ æ•°æ® 
mysql> update student set score=76 where score=72;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql>

#client2--------------------------------------------------------------------------------
                                                          
mysql> begin;                                             
Query OK, 0 rows affected (0.00 sec)                      
                                                          
mysql> select * from student where score=76;              
+-------+--------+-------+                                
| name  | course | score |                                
+-------+--------+-------+                                
| name4 | yuwen  |    76 |                                
| name4 | yuwen  |    76 |                                
+-------+--------+-------+                                
2 rows in set (0.00 sec)                                  
 # è§£å†³äº†å¤šæ¬¡å¿«ç…§è¯»çš„ä¸€ä¸ªå¹»è¯»é—®é¢˜ï¼›                                                         
mysql> select * from student where score=76;              
+-------+--------+-------+                                
| name  | course | score |                                
+-------+--------+-------+                                
| name4 | yuwen  |    76 |                                
| name4 | yuwen  |    76 |                                
+-------+--------+-------+                                
2 rows in set (0.00 sec)                                  
                                                          
mysql> insert into student values('name5','eng',90);      
Query OK, 1 row affected (0.00 sec)                       
# å½“æœ‰å½“å‰è¯»çš„æ—¶å€™éœ€è¦é‡æ–°åˆ›å»ºreadviewï¼›                                                          
mysql> insert into student values('name6','eng',76);      
Query OK, 1 row affected (0.00 sec)                       
                                                          
mysql> select * from student where score=76;              
+-------+--------+-------+                                
| name  | course | score |                                
+-------+--------+-------+                                
| name4 | yuwen  |    76 |                                
| name4 | yuwen  |    76 |                                
| name6 | eng    |    76 |                                
+-------+--------+-------+                                
3 rows in set (0.00 sec)                                  
```

