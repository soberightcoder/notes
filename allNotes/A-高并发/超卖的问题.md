# 超卖的问题

>高并发下超卖的问题；
>
><font color=red>**在分布式环境中，如果并发量很大，这种“查询+修改”的业务有一定概率出现数据不一致。**</font>

----



## MySQL为什么会超卖？

>多线程 ，原子性，需要加锁；加写锁； 

mysql有事务为什么还会超卖？ 事务不是也有原子性吗？

主要原因是mysql 是多线程的；mvcc，快照读不加锁；  

`````php
if  (select stock from goods where id = 1 ) {
    # 并发  会有很多线程进来，并且mvcc 是不加锁的；高并发的时候会进来超过stock（就会超卖）的线程，就会超卖；
    update set stock - 1 where id = 1;
}

##可以使用 select stock from  goods where id = 1 for update;添加写锁那么就不会超卖了；，但是并发量太小了；
## mysql处理不了那么高的并发量；
`````



---



## redis 为什么会超卖？

>单线程，lua原子性，不需要加锁； 不需要加锁；不需要加锁；

因为 redis的命令并不是原子性的；

主要注意的是redis执行命令的线程是单线程的；

```````php
# 单线程只需要保证 命令执行的一致性就可以了   get incr;
# 用lua  来保证查看和修改库存的原子性就可以了；
```````





##  当并发量比较小的时候 小概率发生的时候可以使用CAS （compare  and set） 乐观锁解决这个问题；超卖的问题；



